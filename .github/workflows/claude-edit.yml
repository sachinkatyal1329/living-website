name: Claude Edit

on:
  issues:
    types: [opened]

jobs:
  edit-website:
    if: contains(github.event.issue.labels.*.name, 'edit-request')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Extract phone number
        id: extract
        run: |
          PHONE=$(echo '${{ github.event.issue.body }}' | grep -oP '(?<=\*\*From:\*\* `)[^`]+')
          echo "phone=$PHONE" >> $GITHUB_OUTPUT

      - name: Run Claude to edit website
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "$(cat <<'EOF'
          A user has requested an edit to the website via SMS.

          Their message:
          ${{ github.event.issue.body }}

          Please read CLAUDE.md for instructions on what you can and cannot modify.
          Then read index.html, interpret the user's request, and make appropriate changes.
          Do NOT create any new files. Only edit index.html.
          EOF
          )" --dangerously-skip-permissions

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Edit: ${{ github.event.issue.title }}"
          git push origin main

      - name: Close issue
        run: gh issue close ${{ github.event.issue.number }} --comment "Edit complete! Changes are now live."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for GitHub Pages
        run: sleep 30

      - name: Send confirmation SMS
        if: steps.extract.outputs.phone != ''
        run: |
          curl -X POST "https://api.twilio.com/2010-04-01/Accounts/${{ secrets.TWILIO_ACCOUNT_SID }}/Messages.json" \
            --data-urlencode "To=${{ steps.extract.outputs.phone }}" \
            --data-urlencode "From=${{ secrets.TWILIO_PHONE_NUMBER }}" \
            --data-urlencode "Body=Your edit is now live! Check it out at ${{ secrets.WEBSITE_URL }}" \
            -u "${{ secrets.TWILIO_ACCOUNT_SID }}:${{ secrets.TWILIO_AUTH_TOKEN }}"
